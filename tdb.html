<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard — Inscriptions</title>
  <link rel="icon" href="/JSALI.png"/>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --main-bg: #0a0a0a;
      --highlight: #919191;
      --primary-text: #fff;
      --secondary-text: #cbd5e1;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Space Grotesk', sans-serif;
      background: var(--main-bg);
      color: var(--primary-text);
      padding: 2rem;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    h1 { margin-bottom: 1.5rem; color: var(--highlight); }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: #111;
      border-radius: 0.5rem;
      overflow: hidden;
    }
    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #333;
      white-space: normal;
      word-wrap: break-word;
    }
    th {
      color: var(--highlight);
      background: #1a1a1a;
      font-weight: 600;
    }
    tr:hover { background: rgba(255,255,255,0.03); }
    .btn {
      padding: 0.4rem 0.8rem;
      margin: 0.2rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: bold;
    }
    .accept { background: #16a34a; color: white; }
    .decline { background: #dc2626; color: white; }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #1a1a1a;
      padding: 2rem;
      border-radius: 1rem;
      width: 90%;
      max-width: 600px;
    }
    .modal input, .modal textarea {
      width: 100%;
      padding: 0.5rem;
      margin: 0.5rem 0;
      background: #2a2a2a;
      color: white;
      border: 1px solid #444;
    }
    #message { margin: 1rem 0; padding: 0.5rem; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login Form -->
    <div id="loginSection" class="login-box">
      <h2>Connexion Admin</h2>
      <div id="loginMessage"></div>
      <form id="loginForm">
        <div class="form-group">
          <label for="adminEmail">Email</label>
          <input type="email" id="adminEmail" required>
        </div>
        <div class="form-group">
          <label for="adminPassword">Mot de passe</label>
          <input type="password" id="adminPassword" required>
        </div>
        <button type="submit">Se connecter</button>
      </form>
    </div>

    <!-- Dashboard (hidden until login) -->
    <div id="dashboardSection" class="dashboard hidden">
      <h1>jsali_lvrgt</h1>
      <div id="message"></div>
      <table id="submissions-table">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Email</th>
            <th>Titre de communication</th>
            <th>Axe</th>
            <th>Auteurs(ices)</th>
            <th>Date</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="submissions-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Email Modal -->
  <div id="emailModal" class="modal">
    <div class="modal-content">
      <h2 id="modal-title">Envoyer un email</h2>
      <input type="hidden" id="recipient-email">
      <input type="text" id="email-subject" placeholder="Sujet">
      <textarea id="email-message" rows="6" placeholder="Message..."></textarea>
      <button class="accept" onclick="sendEmail()">Envoyer</button>
      <button onclick="closeModal()">Annuler</button>
      <div id="modal-message" style="margin-top:1rem;"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = 'https://mqsebxyhynaroemoupwy.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xc2VieHloeW5hcm9lbW91cHd5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5MDM0NzgsImV4cCI6MjA3NDQ3OTQ3OH0.ieD61m0CwOt7I2EA8Dstkd5Xd3RgOMQEFs5zpvB9hTU';
    const supabase = createClient(supabaseUrl, supabaseKey);
    const ADMIN_ID = '51822f67-29fa-4d37-a8f6-dc728d5c6e25';
    const EMAIL_FUNCTION_URL = `${supabaseUrl}/functions/v1/send-email`;

    const loginSection = document.getElementById('loginSection');
    const dashboardSection = document.getElementById('dashboardSection');
    const loginForm = document.getElementById('loginForm');
    const loginMessage = document.getElementById('loginMessage');
    const messageEl = document.getElementById('message');
    const tbody = document.getElementById('submissions-body');
    const modal = document.getElementById('emailModal');

    // === Check if already logged in as admin ===
    async function checkAuth() {
      const {  { session } } = await supabase.auth.getSession();
      if (session?.user?.id === ADMIN_ID) {
        loginSection.classList.add('hidden');
        dashboardSection.classList.remove('hidden');
        loadSubmissions();
      }
    }

    // === Login form ===
    loginForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('adminEmail').value;
      const password = document.getElementById('adminPassword').value;

      loginMessage.textContent = "Connexion en cours...";
      loginMessage.style.color = "yellow";

      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password
      });

      if (error) {
        loginMessage.textContent = "Erreur: " + error.message;
        loginMessage.style.color = "red";
      } else if (data.user.id !== ADMIN_ID) {
        await supabase.auth.signOut();
        loginMessage.textContent = "Accès refusé. Vous n'êtes pas administrateur.";
        loginMessage.style.color = "red";
      } else {
        loginSection.classList.add('hidden');
        dashboardSection.classList.remove('hidden');
        loadSubmissions();
      }
    });

    // === Load submissions ===
    async function loadSubmissions() {
      const {  { session } } = await supabase.auth.getSession();
      if (!session?.user || session.user.id !== ADMIN_ID) {
        messageEl.textContent = "Accès refusé. Administrateur uniquement.";
        return;
      }

      const { data, error } = await supabase
        .from('participations')
        .select('*')
        .order('submitted_at', { ascending: false });

      if (error) {
        console.error("Supabase error:", error);
        messageEl.textContent = "Erreur: " + error.message;
        return;
      }

      tbody.innerHTML = data.map(row => `
        <tr>
          <td>${row["Nom"] || ''} ${row["Prénom"] || ''}</td>
          <td>${row["Email"] || ''}</td>
          <td>${row["Titre de communication"] || ''}</td>
          <td>${row["Axe"] || ''}</td>
          <td>${row["Auteurs(ices)"] || ''}</td>
          <td>${new Date(row.submitted_at).toLocaleString('fr-FR')}</td>
          <td>
            <button class="btn accept" onclick="openEmailModal('${row["Email"]}', '✅ Acceptation', 'Félicitations ! Votre soumission a été acceptée.')">Accepter</button>
            <button class="btn decline" onclick="openEmailModal('${row["Email"]}', '❌ Refus', 'Nous regrettons de vous informer que votre soumission n’a pas été retenue.')">Refuser</button>
          </td>
        </tr>
      `).join('');
    }

    // === Modal functions ===
    window.openEmailModal = function(to, subject, message) {
      document.getElementById('recipient-email').value = to;
      document.getElementById('email-subject').value = subject;
      document.getElementById('email-message').value = message;
      modal.style.display = 'flex';
    };

    window.closeModal = function() {
      modal.style.display = 'none';
      document.getElementById('modal-message').textContent = '';
    };

    window.sendEmail = async function() {
      const to = document.getElementById('recipient-email').value;
      const subject = document.getElementById('email-subject').value;
      const message = document.getElementById('email-message').value;
      const modalMsg = document.getElementById('modal-message');

      if (!to || !subject || !message) {
        modalMsg.textContent = "Tous les champs sont requis.";
        modalMsg.style.color = "red";
        return;
      }

      modalMsg.textContent = "Envoi en cours...";
      modalMsg.style.color = "yellow";

      try {
        const response = await fetch(EMAIL_FUNCTION_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ to, subject, message })
        });

        const result = await response.json();
        if (result.success) {
          modalMsg.textContent = "Email envoyé !";
          modalMsg.style.color = "green";
          setTimeout(() => closeModal(), 1500);
        } else {
          throw new Error(result.error || 'Échec');
        }
      } catch (err) {
        modalMsg.textContent = "Erreur: " + err.message;
        modalMsg.style.color = "red";
      }
    };

    window.onclick = function(event) {
      if (event.target === modal) closeModal();
    };

    // Initial check
    checkAuth();
  </script>
</body>
</html>
